<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libraries/PortfolioLibrary.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libraries/</a> PortfolioLibrary.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>26/39</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">70% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>14/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.33% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">65% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>26/40</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">58×</span>
<span class="cline-any cline-yes">58×</span>
<span class="cline-any cline-yes">58×</span>
<span class="cline-any cline-yes">58×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">58×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">146×</span>
<span class="cline-any cline-yes">146×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">85×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: Unlicense
pragma solidity 0.6.12;
&nbsp;
import "@openzeppelin/contracts/math/SafeMath.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "../interfaces/IPortfolio.sol";
import "../interfaces/IOracle.sol";
&nbsp;
&nbsp;
library PortfolioLibrary {
    using SafeMath for uint256;
    uint256 private constant DIVISOR = 1000;
&nbsp;
    /*
     * @notice This function verifies that the structure passed in parameters is valid
     * @dev We check that the array lengths match, that the percentages add 100%,
     *      no zero addresses, and no duplicates
     */
     // TODO: check for 0 percentage?
    function verifyStructure(
        address[] memory tokens,
        uint256[] memory percentages
    ) internal pure returns (bool) {
        require(
            tokens.length == percentages.length,
            "Portfolio._verifyAndSetStructure: Different array lengths"
        );
        uint256 total = 0;
        for (uint256 i = 0; i &lt; tokens.length; i++) {
            <span class="missing-if-branch" title="else path not taken" >E</span>require(
                tokens[i] != address(0),
                "Portfolio._verifyAndSetStructure: No zero address, please use WETH address"
            );
            require(
                i == 0 ||
                tokens[i] &gt; tokens[i-1],
                "Portfolio._verifyAndSetStructure: Duplicate token address or addresses out of order"
            );
            total = total.add(percentages[i]);
        }
        require(
            total == DIVISOR,
            "Portfolio._verifyAndSetStructure: Percentages do not add up to 100%"
        );
        /*
        if (tokens.length != percentages.length) return false;
        uint256 total = 0;
        for (uint256 i = 0; i &lt; tokens.length; i++) {
            if (tokens[i] == address(0)) return false;
            if (i != 0 &amp;&amp; tokens[i] &lt;= tokens[i-1]) return false;
            total = total.add(percentages[i]);
        }
        if (total != DIVISOR) return false;
        return true;
        */
    }
&nbsp;
    function checkBalance(
        address portfolio,
        address[] memory tokens,
        uint256 threshold
    ) internal view returns (bool) {
        address oracle = IPortfolio(portfolio).oracle();
        (uint256 total, uint256[] memory estimates) = IOracle(oracle).estimateTotal(portfolio, tokens);
        bool balanced = true;
        for (uint256 i = 0; i &lt; tokens.length; i++) {
            address tokenAddress = tokens[i];
            uint256 expectedValue = getExpectedTokenValue(total, portfolio, tokenAddress);
            uint256 rebalanceRange = getRange(expectedValue, threshold);
            <span class="missing-if-branch" title="if path not taken" >I</span>if (estimates[i] &gt; expectedValue.add(rebalanceRange)) {
<span class="cstat-no" title="statement not covered" >                balanced = false</span>;
                break;
            }
            if (estimates[i] &lt; expectedValue.sub(rebalanceRange)) {
                balanced = false;
                break;
            }
        }
        return balanced;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function imbalanceMagnitude(</span>
        address portfolio,
        address[] memory tokens
    ) internal view returns (uint256) {
<span class="cstat-no" title="statement not covered" >        address oracle = IPortfolio(portfolio).oracle();</span>
<span class="cstat-no" title="statement not covered" >        (uint256 total, uint256[] memory estimates) = IOracle(oracle).estimateTotal(portfolio, tokens);</span>
<span class="cstat-no" title="statement not covered" >        uint256 magnitude = 0;</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; tokens.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            address tokenAddress = tokens[i];</span>
<span class="cstat-no" title="statement not covered" >            uint256 expectedValue = getExpectedTokenValue(total, portfolio, tokenAddress);</span>
<span class="cstat-no" title="statement not covered" >            uint256 estimatedValue = estimates[i];</span>
<span class="cstat-no" title="statement not covered" >            if (estimatedValue &gt; expectedValue) {</span>
<span class="cstat-no" title="statement not covered" >                magnitude = magnitude.add(estimatedValue.sub(expectedValue))</span>;
            }
<span class="cstat-no" title="statement not covered" >            if (estimatedValue &lt; expectedValue) {</span>
<span class="cstat-no" title="statement not covered" >                magnitude = magnitude.add(expectedValue.sub(estimatedValue))</span>;
            }
        }
<span class="cstat-no" title="statement not covered" >        return magnitude;</span>
    }
&nbsp;
    function getTokenValue(address portfolio, address token)
        internal
        view
        returns (uint256)
    {
        IOracle oracle = IOracle(IPortfolio(portfolio).oracle());
        if (token == address(0)) {
            return address(this).balance;
        } else if (token == oracle.weth()) {
            return IERC20(token).balanceOf(portfolio);
        } else {
            return oracle.consult(
                IERC20(token).balanceOf(portfolio),
                token
            );
        }
    }
&nbsp;
    function getExpectedTokenValue(
        uint256 total,
        address portfolio,
        address token
    ) internal view returns (uint256) {
        return total
            .mul(IPortfolio(portfolio).getTokenPercentage(token))
            .div(DIVISOR);
    }
&nbsp;
    function getRange(uint256 expectedValue, uint256 threshold) internal pure returns (uint256) {
        return expectedValue.mul(threshold).div(DIVISOR);
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jan 19 2021 20:45:09 GMT-0800 (Pacific Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
